name: Apache Shiro 路径穿越漏洞
title: CVE-2016-6802 Apache Shiro 路径穿越漏洞
severity: 高危漏洞
severity_level: high
threat_level: 高危
cvss_score: 7.5
cvss_vector: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
cve: CVE-2016-6802
icon: fa-shield-alt
description: Apache Shiro 1.3.2 之前版本路径标准化处理缺陷导致的权限绕过漏洞

perspectives:
  - id: overview
    name: 漏洞概述
    icon: fa-info-circle
    title: 漏洞概述视角
    description: CVE-2016-6802 的基本概念、原理和影响范围
    content:
      columns:
        - boxes:
            - type: info
              title: 什么是 CVE-2016-6802？
              icon: fa-question-circle
              content: |
                CVE-2016-6802 是 Apache Shiro 框架中的一个路径穿越漏洞。在 Shiro 1.3.2 之前版本中，由于未对 ContextPath 做路径标准化处理，攻击者可以构造含 `/任意目录名/../` 的畸形路径，篡改 ContextPath 生成错误的 RequestURI，从而绕过 Servlet 过滤器的权限校验实现未授权访问。
            - type: info
              border_color: blue
              title: 漏洞原理
              icon: fa-cogs
              content: |
                当 Web 应用配置了非根目录的上下文路径（如 `server.servlet.context-path=/h5`）时，Shiro 在处理请求路径时未对 ContextPath 进行标准化处理。攻击者可以通过构造包含路径穿越字符（`../`）的请求路径，使得 Shiro 生成的 RequestURI 与实际访问路径不一致，从而绕过配置的权限校验规则。
              code_example: |
                // 正常访问路径
                /h5/hello/test

                // 攻击者构造的路径
                /h5/aaa/../hello/test

                // Shiro 处理后的 RequestURI 可能被错误解析
                // 导致权限校验失效
        - boxes:
            - type: info
              border_color: green
              title: 受影响版本
              icon: fa-bug
              content:
                type: list
                items:
                  - Apache Shiro < 1.3.2
                  - 所有使用受影响版本 Shiro 的 Web 应用
            - type: info
              border_color: purple
              title: 环境条件
              icon: fa-server
              content:
                type: list
                items:
                  - Web 应用需配置非根目录的上下文路径（如 server.servlet.context-path=/h5）
                  - 若为根目录（context-path=/）则不存在此漏洞
                  - 需要配置了需要权限校验的路径
      sections:
        - type: attack_flow
          title: 攻击流程
          icon: fa-bolt
          steps:
            - 攻击者发现应用使用非根目录上下文路径
            - 构造包含路径穿越的畸形请求路径
            - Shiro 未标准化处理 ContextPath
            - 生成的 RequestURI 与预期不一致
            - 绕过权限校验规则实现未授权访问
        - type: impact
          title: 漏洞影响
          icon: fa-exclamation-triangle
          items:
            - icon: fa-unlock-alt
              title: 权限绕过
              description: 绕过 Shiro 配置的权限校验，访问受保护的资源
              color: red
            - icon: fa-user-secret
              title: 未授权访问
              description: 无需认证即可访问需要权限控制的接口
              color: blue
            - icon: fa-database
              title: 数据泄露
              description: 可能访问到敏感数据或管理功能
              color: green
            - icon: fa-server
              title: 系统风险
              description: 可能导致整个权限体系失效
              color: purple

  - id: victim
    name: 受害者视角
    icon: fa-user-shield
    title: 受害者视角
    description: 开发者可能面临的风险及防护建议
    content:
      columns:
        - boxes:
            - type: info
              title: 开发者的风险
              icon: fa-user-injured
              content: |
                作为使用 Apache Shiro 框架的开发者，如果您的应用使用了低于 1.3.2 版本的 Shiro，并且配置了非根目录的上下文路径，那么您的应用可能面临权限绕过的风险。攻击者可能无需认证即可访问您认为受保护的接口。
            - type: info
              border_color: blue
              title: 如何识别是否受影响？
              icon: fa-shield-alt
              content:
                type: list
                items:
                  - 检查 pom.xml 或 build.gradle 中的 Shiro 版本号
                  - 确认是否配置了非根目录的 context-path（如 /h5、/api 等）
                  - 检查应用日志中是否有异常的路径访问记录
                  - 使用安全扫描工具检测是否存在路径穿越漏洞
                  - 测试构造畸形路径是否能绕过权限校验
        - boxes:
            - type: info
              border_color: green
              title: 可能造成的损害
              icon: fa-exclamation-circle
              content:
                type: list
                items:
                  - "权限体系失效：攻击者可以绕过所有 Shiro 配置的权限规则"
                  - "敏感数据泄露：未授权访问可能暴露用户数据、配置信息等"
                  - "功能滥用：攻击者可能调用管理接口或执行敏感操作"
                  - "合规风险：数据泄露可能导致违反 GDPR、个人信息保护法等法规"
                  - "业务影响：未授权访问可能影响业务逻辑，造成经济损失"
      sections:
        - type: impact
          title: 作为开发者如何防护？
          icon: fa-user-check
          items:
            - icon: fa-arrow-up
              title: 及时升级
              description: 将 Shiro 升级到 1.3.2 及以上版本
              color: red
            - icon: fa-check-circle
              title: 版本检查
              description: 定期检查依赖版本，使用最新稳定版
              color: blue
            - icon: fa-shield-alt
              title: 安全测试
              description: 进行渗透测试，验证权限校验是否有效
              color: green
            - icon: fa-bell
              title: 监控告警
              description: 配置异常访问监控，及时发现攻击行为
              color: purple
        - type: info
          title: 开发者应对措施
          icon: fa-lightbulb
          columns:
            - title: 发现漏洞后立即：
              content:
                type: list
                items:
                  - 立即升级 Shiro 到 1.3.2 或更高版本
                  - 检查应用日志，确认是否有未授权访问记录
                  - 评估受影响的数据和功能范围
                  - 通知相关用户并采取应急措施
            - title: 长期防护策略：
              content:
                type: list
                items:
                  - 建立依赖版本管理机制，定期更新安全补丁
                  - 实施安全开发生命周期（SDLC），在开发阶段进行安全测试
                  - 配置 Web 应用防火墙（WAF）规则
                  - 定期进行安全审计和渗透测试

  - id: attacker
    name: 攻击者视角
    icon: fa-user-secret
    title: 攻击者视角
    description: 攻击者的目标、方法与利用技巧
    content:
      columns:
        - boxes:
            - type: info
              title: 攻击者的目标与方法
              icon: fa-crosshairs
              content: |
                攻击者通常通过信息收集发现目标应用使用了 Apache Shiro 框架，然后尝试构造路径穿越请求来绕过权限校验，最终目标是访问受保护的接口或获取敏感数据。
            - type: info
              border_color: blue
              title: 攻击步骤
              icon: fa-search
              content:
                type: list
                items:
                  - "信息收集：识别目标应用使用的框架和版本（通过错误信息、响应头等）"
                  - "环境探测：确认应用是否配置了非根目录的 context-path"
                  - "路径构造：构造包含路径穿越字符的畸形路径（如 /h5/aaa/../hello/test）"
                  - "权限测试：测试不同路径组合，寻找可绕过权限校验的路径"
                  - "利用攻击：成功绕过后访问受保护的接口或功能"
        - boxes:
            - type: info
              border_color: green
              title: 攻击者常用的技巧
              icon: fa-tools
              content:
                type: list
                items:
                  - "路径穿越：使用 ../ 构造畸形路径"
                  - "URL 编码：尝试 URL 编码绕过（%2e%2e%2f）"
                  - "双重编码：使用双重 URL 编码"
                  - "路径混淆：结合多个路径分隔符"
                  - "大小写混淆：尝试不同大小写组合"
            - type: info
              border_color: purple
              title: 攻击目标优先级
              icon: fa-bullseye
              content:
                type: list
                items:
                  - 用户管理接口（获取用户列表、修改用户信息）
                  - 数据查询接口（获取敏感数据）
                  - 文件操作接口（上传、下载、删除文件）
                  - 系统配置接口（修改系统设置）
                  - 管理后台功能
      sections:
        - type: code_examples
          title: 常见攻击 Payload 示例
          icon: fa-code
          examples:
            - title: 基础路径穿越
              code: |
                # 假设受保护路径为 /h5/hello/test
                # 配置了 /aaa/* 为匿名访问

                # 攻击请求
                GET /h5/aaa/../hello/test HTTP/1.1

                # 或者
                GET /h5/bbb/../hello/test HTTP/1.1
            - title: URL 编码绕过
              code: |
                # URL 编码版本
                GET /h5/aaa%2f%2e%2e%2fhello/test HTTP/1.1

                # 双重编码
                GET /h5/aaa%252f%252e%252e%252fhello/test HTTP/1.1
        - type: table
          title: 漏洞利用场景
          icon: fa-clipboard-list
          headers:
            - 场景
            - 配置条件
            - 利用方式
          rows:
            - [
                全局匿名访问,
                'map.put("/**", "anon")',
                利用任意匿名路径 + ../ 访问受保护路径,
              ]
            - [
                部分路径匿名,
                'map.put("/aaa/*", "anon")',
                利用 /aaa/../ 访问其他路径,
              ]
            - [
                登录接口匿名,
                'map.put("/doLogin/*", "anon")',
                利用 /doLogin/../ 访问受保护路径,
              ]

  - id: code
    name: 代码触发
    icon: fa-code
    title: 代码触发视角
    description: 漏洞复现代码示例及修复方案
    content:
      columns:
        - boxes:
            - type: info
              title: 易受攻击的配置示例
              icon: fa-exclamation-triangle
              content: |
                下面展示了一个存在 CVE-2016-6802 漏洞的 Spring Boot + Shiro 应用配置：
              code_example: |
                // pom.xml - 使用易受攻击的版本
                <dependency>
                    <groupId>org.apache.shiro</groupId>
                    <artifactId>shiro-web</artifactId>
                    <version>1.3.1</version>  <!-- 低于 1.3.2 -->
                </dependency>
                <dependency>
                    <groupId>org.apache.shiro</groupId>
                    <artifactId>shiro-spring</artifactId>
                    <version>1.3.1</version>
                </dependency>
              content_after: |
                关键配置：
              code_example_2: |
                # application.properties
                # 配置非根目录上下文路径（漏洞触发条件）
                server.servlet.context-path=/h5

                # Shiro 配置
                # 配置了全局匿名访问
                map.put("/**", "anon");
                # 或部分路径匿名访问
                map.put("/aaa/*", "anon");
            - type: info
              border_color: blue
              title: Controller 示例
              icon: fa-file-code
              content: |
                受保护的接口：
              code_example: |
                @RestController
                public class LoginController {
                    
                    // 需要认证的接口
                    @GetMapping("/hello/**")
                    public String hello() {
                        return "hello";
                    }
                    
                    // 登录接口（匿名访问）
                    @PostMapping("/doLogin")
                    public void doLogin(String username, String password) {
                        Subject subject = SecurityUtils.getSubject();
                        subject.login(new UsernamePasswordToken(username, password));
                    }
                }
        - boxes:
            - type: info
              border_color: green
              title: Shiro 配置类
              icon: fa-cog
              content: |
                漏洞配置：
              code_example: |
                @Configuration
                public class ShiroConfig {
                    
                    @Bean
                    ShiroFilterFactoryBean shiroFilterFactoryBean() {
                        ShiroFilterFactoryBean bean = new ShiroFilterFactoryBean();
                        bean.setSecurityManager(securityManager());
                        
                        Map<String, String> map = new LinkedHashMap<>();
                        // 关键：配置了匿名访问路径
                        map.put("/doLogin/*", "anon");
                        map.put("/aaa/*", "anon");  // 或 map.put("/**", "anon");
                        map.put("/hello/*", "authc");  // 需要认证
                        
                        bean.setFilterChainDefinitionMap(map);
                        return bean;
                    }
                }
              content_after: |
                攻击方式：
              code_example_2: |
                # 正常访问（会被拦截，需要认证）
                GET /h5/hello/test

                # 利用路径穿越绕过（成功访问，无需认证）
                GET /h5/aaa/../hello/test
                GET /h5/doLogin/../hello/test
      sections:
        - type: table
          title: 漏洞复现步骤
          icon: fa-vial
          headers:
            - 步骤
            - 操作
            - 预期结果
          rows:
            - [1, 配置 Shiro 1.3.1 版本和非根目录 context-path, 环境搭建完成]
            - [2, 配置权限规则，设置部分路径匿名访问, 权限配置生效]
            - [3, 正常访问受保护路径 /h5/hello/test, 被拦截，要求认证]
            - [4, 构造路径穿越请求 /h5/aaa/../hello/test, 成功绕过，无需认证]
        - type: impact
          title: 修复方案
          icon: fa-shield-alt
          items:
            - icon: fa-arrow-up
              title: 版本升级
              description: 升级 Shiro 到 1.3.2 或更高版本
              color: red
            - icon: fa-check-double
              title: 路径标准化
              description: 确保 ContextPath 处理正确
              color: blue
            - icon: fa-lock
              title: 权限加固
              description: 避免配置过于宽松的匿名访问规则
              color: green
            - icon: fa-shield-halved
              title: 安全配置
              description: 使用最小权限原则配置权限规则
              color: purple
        - type: info
          title: 修复代码示例
          icon: fa-wrench
          columns:
            - title: 升级依赖版本：
              content:
                type: list
                items:
                  - 修改 pom.xml 中的版本号
                  - 将 shiro-web 和 shiro-spring 升级到 1.3.2+
                  - 重新编译和部署应用
            - title: 修复后的配置：
              content:
                type: list
                items:
                  - 使用 Shiro 1.3.2+ 版本（已修复路径标准化问题）
                  - 审查权限配置，避免过于宽松的规则
                  - 进行安全测试，验证修复效果

footer_note: 此卡片仅用于教育目的，帮助理解 CVE-2016-6802 漏洞的原理和防护方法。请勿用于非法用途。

additional_info:
  cve_url: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-6802
  fofa_query: app="Apache-Shiro" && version<"1.3.2"
  pocs:
    - name: Shiro 路径穿越漏洞 POC
      url: https://github.com/example/shiro-cve-2016-6802-poc
      description: GitHub 上的概念验证代码
    - name: CVE-2016-6802 漏洞复现
      url: https://www.exploit-db.com/exploits/XXXXX
      description: Exploit-DB 上的利用脚本
  tools:
    - name: Shiro 漏洞检测工具
      url: https://github.com/example/shiro-scanner
      description: 自动化检测 Shiro 相关漏洞的工具
